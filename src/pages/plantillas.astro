---
import DashboardLayout from "../layouts/DashboardLayout.astro";
---

<DashboardLayout>
  <section class="p-6 text-white">
    <h1 class="text-2xl font-bold mb-4">Plantillas</h1>

    <input
      id="search"
      placeholder="Buscar plantillas..."
      class="px-3 py-2 rounded text-black w-[300px]"
    />

    <p class="mt-2 text-sm">
      Resultados: <span id="count">0</span>
    </p>

    <div class="overflow-x-auto mt-4">
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-slate-800 text-left">
            <th class="p-2">Aplicativo</th>
            <th class="p-2">Solicitud</th>
            <th class="p-2">Servicio</th>
            <th class="p-2">Resumen</th>
            <th class="p-2">Cierre</th>
          </tr>
        </thead>
        <tbody id="body"></tbody>
      </table>
    </div>
  </section>

  <!-- MODAL -->
  <div
    id="modal"
    class="fixed inset-0 hidden bg-black/60 flex items-center justify-center z-50"
  >
    <div class="bg-slate-900 text-white p-6 rounded-xl w-[600px] shadow-xl">

      <div id="modalContent" class="space-y-2 text-sm"></div>

        <div class="mt-4 text-right">
        <button
          id="closeBtn"
          class="px-4 py-2 bg-blue-600 rounded hover:bg-blue-700"
        >
        </button>
      </div>
    </div>
  </div>
  <style>
body {
  background: linear-gradient(180deg, #041a2d, #031322);
  color: #ffffff;
  font-family: Inter, system-ui, sans-serif;
}

h1 {
  font-size: 1.9rem;
  letter-spacing: .5px;
}

/* -------- BUSCADOR -------- */
#search {
  width: 640px;
  padding: 12px 16px;
  border-radius: 10px;
  border: none;
  outline: none;
  background: #0b2a45;
  color: white;
  font-size: 14px;
  box-shadow: inset 0 0 0 1px #1e4c7a;
}

#search::placeholder {
  color: #9fb9d3;
}

/* -------- TABLA -------- */
table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 6px;
  table-layout: fixed;
}

thead th {
  font-size: 13px;
  font-weight: 600;
  color: #9fd3ff;
  text-align: left;
  padding: 10px 14px;
  white-space: nowrap;
}

tbody tr {
  background: rgba(255,255,255,0.03);
  transition: .2s;
}

tbody tr:hover {
  background: rgba(80,150,255,0.12);
}

/* -------- CELDAS -------- */
td {
  position: relative;
  padding: 14px 16px;
  font-size: 13.5px;
  line-height: 1.5;
  vertical-align: top;
  word-break: break-word;
  white-space: normal;
  overflow: hidden;
}

/* âœ… SEPARADOR HORIZONTAL REAL */
tbody td {
  border-bottom: 1px solid rgba(255,255,255,.12);
}

tbody tr:last-child td {
  border-bottom: none;
}

/* -------- SEPARADOR VERTICAL -------- */
td:not(:last-child)::after {
  content: "";
  position: absolute;
  right: 0;
  top: 15%;
  width: 1px;
  height: 70%;
  background: rgba(255,255,255,.08);
}
tbody tr:hover td {
  border-bottom: 1px solid rgba(120,180,255,.45);
}

/* -------- ANCHOS -------- */
th:nth-child(1), td:nth-child(1) { width: 110px; }
th:nth-child(2), td:nth-child(2) { width: 160px; }
th:nth-child(3), td:nth-child(3) { width: 340px; }
th:nth-child(4), td:nth-child(4) { width: 520px; }
th:nth-child(5), td:nth-child(5) { width: 300px; }


/* -------- RESALTADO -------- */
mark {
  background: #ffd54f;
  color: #000;
  padding: 2px 4px;
  border-radius: 4px;
}

/* -------- COMPACTO -------- */
.compact td {
  padding: 10px 14px;
  font-size: 13px;
}

  </style>

  <script is:inline>
    const input = document.getElementById("search");
    const body = document.getElementById("body");
    const count = document.getElementById("count");
    //const modal = document.getElementById("modal");
    //const modalContent = document.getElementById("modalContent");
    //const closeBtn = document.getElementById("closeBtn");

    let cache = [];

    function highlight(text, q) {
      if (!q) return text;
      const reg = new RegExp(`(${q})`, "gi");
      return text.replace(reg, "<mark>$1</mark>");
    }

    async function load(q = "") {
      if (!cache.length) {
        const res = await fetch(`/plantillas-system/api/plantillas`);
        cache = await res.json();
      }

      const query = q.toLowerCase();

      const filtered = cache.filter(p =>
        Object.values(p).some(v =>
          String(v).toLowerCase().includes(query)
        )
      );

      count.textContent = filtered.length;

      body.innerHTML = filtered.map((p, i) => `
        <tr data-index="${i}" class="row cursor-pointer">
          <td class="font-semibold">${highlight(p.aplicativo ?? "", q)}</td>
          <td>${highlight(p.solicitud ?? "", q)}</td>
          <td>${highlight(p.servicio ?? "", q)}</td>
          <td>${highlight(p.resumen ?? "", q)}</td>
          <td class="text-blue-300">${highlight(p.cierre ?? "", q)}</td>
        </tr>
      `).join("");

      document.querySelectorAll(".row").forEach(row => {
        row.addEventListener("click", () => {
          openModal(filtered[row.dataset.index]);
        });
      });
    }

    closeBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
    });

    input.addEventListener("input", e => load(e.target.value));

    load();
  </script>
</DashboardLayout>
